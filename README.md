

# TwoToneDetect Python Integration

## Version: 1.0.0  
**Date:** 2024-08-28  
**Author:** Quentin King

## Project Overview

This project provides Python scripts that extend the functionality of the TwoToneDetect software, which monitors audio from fire department dispatch radios. TwoToneDetect identifies specific tones that correspond to different fire departments and triggers predefined commands. This project includes three Python scripts:

1. **TwoToneDetect Pre-Notification**: Triggered immediately when tones are detected. It sends a webhook notification with information about the detected tones.
2. **TwoToneDetect Audio Notification**: Triggered after the dispatch audio has been recorded. This script uploads the audio file to an FTP server and sends a webhook notification with the URL to the file.
3. **Heartbeat Monitor**: Monitors the heartbeat log file generated by TwoToneDetect, ensuring the software is functioning properly. If the heartbeat stops, this script sends a Pushover notification.

These scripts are designed to integrate seamlessly with TwoToneDetect and provide enhanced notification and monitoring capabilities.

## Setup Instructions

### 1. Prerequisites

- **Python 3.6+**: Ensure Python is installed on your system.
- **Python Libraries**: Install the required Python libraries:
  ```bash
  pip install requests configparser
  ```

### 2. Configuration Files

The scripts rely on several `.ini` configuration files to manage settings and credentials. These files should be placed in the same directory as the Python scripts.

#### **config.ini**

Handles general configuration settings, including logging and retry mechanisms.

```ini
[Logging]
log_dir = logs/
cleanup_days = 5
log_level = INFO

[Retries]
max_retries = 3
retry_delay = 300

[Webhook]
ttd_audio_received_url = ${WEBHOOK_URL}
tone_detected_url = ${TONE_DETECTED_WEBHHOOK_URL}
base_audio_url = ${BASE_AUDIO_URL}
```

#### **pushover.ini**

Contains Pushover API credentials and notification settings.

```ini
[Pushover]
PUSHOVER_TOKEN = your_pushover_token
PUSHOVER_USER = your_pushover_user_key
priority = 1
```

#### **heartbeat.ini**

Contains settings specific to heartbeat monitoring.

```ini
[Heartbeat]
file_path = C:\path\to\your\heartbeat.log
check_interval = 90
threshold = 135
```

### 3. Internal Configuration (TwoToneDetect)

To integrate the Python scripts with TwoToneDetect, you need to modify the `tone.cfg` file that comes with TwoToneDetect.

#### **Pre-Notification Command**

Add the following line to trigger the pre-notification script:

```ini
alert_command = python "C:\path\to\your\ttd_pre_notification.py" [mp3] [d]
```

- **[mp3]**: Placeholder for the audio file name.
- **[d]**: Placeholder for the department name.

#### **Audio Notification and FTP Command**

Add the following line to trigger the audio upload and notification script:

```ini
post_email_command = python "C:\path\to\your\ttd_audio_notification.py" [mp3] [d]
```

- **[mp3]**: Placeholder for the audio file name.
- **[d]**: Placeholder for the department name.

### 4. Running the Scripts

#### **TwoToneDetect Pre-Notification**

This script is triggered immediately when tones are detected by TwoToneDetect.

```bash
python ttd_pre_notification.py <file_name> <topic>
```

- **file_name**: The name of the audio file (optional, can be any placeholder).
- **topic**: The department or topic for the notification.
- **--retries**: Number of retry attempts for sending the webhook (default is 3).

#### **TwoToneDetect Audio Notification**

This script is triggered after the dispatch audio has been recorded.

```bash
python ttd_audio_notification.py <file_name> <department>
```

- **file_name**: The path to the recorded audio file.
- **department**: The department name associated with the audio file.

#### **Heartbeat Monitor**

This script continuously monitors the heartbeat log file generated by TwoToneDetect.

```bash
python heartbeat_monitor.py
```

- No command-line arguments are needed; the script reads all necessary configurations from the `.ini` files.

### 5. Logging Information

- Logs are stored in the directory specified in the `log_dir` configuration (`logs/` by default).
- Log files are rotated automatically when they reach 1MB in size.
- The following log files are generated:
  - `ttd_pre_notification.log`: Logs for the Pre-Notification script.
  - `ttd_audio_notification.log`: Logs for the Audio Notification script.
  - `ttd_heartbeat.log`: General logs for the Heartbeat Monitor script.
  - `ttd_heartbeat_webhook_alerts.log`: Logs related to webhook alerts sent by the Heartbeat Monitor.
  - `ttd_heartbeat_pushover_alerts.log`: Logs related to Pushover alerts sent by the Heartbeat Monitor.

### 6. Versioning and Changelog

Versioning is managed within each script, with updates noted in the changelog at the top of each file. The current versions are:

- **TwoToneDetect Pre-Notification**: v1.7.1
- **TwoToneDetect Audio Notification**: v1.7.0
- **Heartbeat Monitor**: v1.7.0

### 7. Security Considerations

- **Sensitive Information**: API tokens and other sensitive credentials are stored in the `pushover.ini` file. Ensure this file is kept secure and not exposed to unauthorized users.
- **Configuration Files**: Only share the sanitized version of the `.ini` files that do not contain sensitive information. Use placeholders in public versions.
- **Access Control**: Ensure that only trusted individuals have access to the scripts and configuration files, especially those that contain sensitive credentials.

## Troubleshooting

### Common Issues

1. **Missing Configuration Files**: Ensure that all required `.ini` files are in the same directory as the Python scripts.
2. **Invalid Credentials**: Double-check the Pushover API credentials in `pushover.ini` if notifications are not being sent.
3. **File Paths**: Ensure that the paths specified in `heartbeat.ini` and other configuration files are correct and accessible.

### Dependencies and Python Version

- **Dependencies**: The scripts require the `requests` and `configparser` libraries, which can be installed via pip.
- **Python Version**: The scripts are compatible with Python 3.6 and later.
